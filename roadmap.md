# 总览

- [x] 修复多线程导致的消费不正常,无法准确控制消息消费
- [ ] 整体异常控制流程优化,让每一个异常能够得到更加正确的处理
- [ ] 整体配置流程优化,更多的复用,包括网站总体配置,每个请求的单独配置
- [ ] 更精准的抽象,主要针对下载器,下载器不能很好的配合配置项

# 细节

## 多线程

消息消费由多线程换成单线程,异步特性由消息管理器换成消息管理器总体把控,能够在消费控制上有更好的表现,也将压力放到消息管理器,能够更好的利用消息管理器内存优化,而不是由消费者来进行优化,消息管理器很多时候使用第三方实现例如kafka/redis等,有更好的内存控制优化,也更容易把控/

## 异常

主要是对于异常定位进行处理,访问网站出现异常不一定会按照http错误码规范进行返回,异常判断很多时候需要借助具体返回内容匹配进行判断,所以需要加上异常匹配.另外对于不同的异常可能采取不同的处理方式,例如重新尝试多次,或者直接取消此次请求等等.

## 配置流程

整体配置需要进行更高级的抽象,具体实现可能有更多的配置来源,例如文件/数据库/sdk等等.配置项需要更加明确,分为两类,网站请求配置和抓取配置.

### 网站请求配置

* domain:网站域名
* userAgent:访问的浏览器标识
* defaultCookies:默认会携带的cookie
* extras:其他的请求头
* charset:编码配置
* sleepTime:每次请求的间隔时间(有争议,当多线程/分布式情况下无法控制,需要更好的解决方案)
* retryTimes:当请求失败时的重试次数
* retrySleepTime:重试时的间隔时间(有争议,同上)
* timeOut:超时时间
* acceptedStatCode:被接受的请求码(可以作为成功标识)
* useGzip:使用gzip压缩
* userCookie:是否需要使用cookie,当为true时,cookie会被继承下去
* ErrorMatchers:高级的异常匹配器

###配置

整个抓取流程分为三层:从规则管理器中获取规则配置文件->规则配置解析器进行翻译->规则执行器执行实际抓取.为了最大限度的使界限分明并更好的使用,实际的抓取器(selector)将简化api,不再提供一些多余的方法,规则配置将外部化.由规则管理器进行管控.

配置文件主要以字符串的形式进行流通,提供转换机制,能够兼容更多的来源以及格式.

具体配置要素:

| 字段名        | 类型                 | 说明                                                                                             |
|---------------|----------------------|--------------------------------------------------------------------------------------------------|
| target        | UrlMatcher           | 爬虫到达目标页面的匹配标志                                                                       |
| help          | UrlMatcher           | 爬虫到达目标页面可能经过的url,这些路径是用来辅助获得最终目标页面的,默认匹配所有路径,类似全站爬取 |
| children      | List<ContentMatcher> | 内容结果匹配规则,用来配置哪些内容会被抓取到结果集中                                              |
| errorMatchers | List<ContentMatcher> | 异常匹配规则,用来配置是访问是否发生错误,例如404等等                                              |

urlMacher:

| 字段名       | 类型               | 说明                                                                                                              |
|--------------|--------------------|-------------------------------------------------------------------------------------------------------------------|
| type         | string             | 目前仅支持regex,默认regex                                                                                         |
| value        | string             | 正则表达式                                                                                                        |
| sourceRegion | string             | url选择范围,用来规定url目标url出现在哪里,例如爬去文章时,列表旁的推荐拥有类似的url,在此可以进行忽略                |
| linkProperty | List<LinkProperty> | 很少用到,主要是类似微信这样,目标url很可能不是出现在a标签下面的href属性中,可以通过此选项进行规定,url出现在什么地方 |

LinkProperty:

| 字段名 | 类型   | 说明       |
|--------|--------|------------|
| tag    | string | 标签名     |
| attr   | string | 标签属性名 |

contentMatcher:


| 字段名   | 类型   | 说明                                                                             |
|----------|--------|----------------------------------------------------------------------------------|
| name     | string | 内容命名                                                                         |
| value    | string | 匹配表达式                                                                       |
| type     | string | 匹配表达式类型,支持xpath,regex,css                                               |
| nullable | bool   | 是否允许为空,如果此处填写不允许为空,如果没有抓到此属性,将会跳过这个结果          |
| source   | string | 抽取范围,内容不一定会处在html中,有可能在url中,所以此处提供多个范围,HTML/TEXT/URL |

